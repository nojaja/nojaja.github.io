<!DOCTYPE html>
<html class=''>
<head>
<meta charset='UTF-8'>
<meta name="robots" content="noindex">
<link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.5/css/uikit.min.css'>
<style class="cp-pen-styles">.container {
  display: inline-block;
  width: 40%;
  border: 1px solid grey
}
.editor {
  width: 100%;
  height: 300px;
}
.code-frame {
  display: inline-block;
  width: 40%;
  border: 1px solid grey;
    border-radius: 3px;
    margin: 1em 0;
    background-color: #f7f7f7;
    line-height: 0;
    overflow: hidden; }
.code-lang {
    color: #555;
    display: inline-block;
    padding: .25em .5em;
    margin: 0;
    line-height: 1;
    background-color: rgba(0, 0, 0, 0.07);
    font-size: .8em;
    font-weight: normal; }
pre {
      border-radius: 3px;
      border: 0;
      margin: 0;
      padding: .6em 1.2em;
      line-height: 1.2;
      background-color: #f7f7f7;
      overflow-x: auto;
      word-wrap: normal;
      white-space: pre;
      font-size: .8em;
      font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace; }</style></head><body>
<div class="code-frame">
  <div class="code-lang"><span class="bold">info</span></div>
  <pre>
   htmlparser.js + htmlcompiler.jsによるWebcomponentのトラインスパイル
   
   "source html" に記載されたWebcomponentからhtmlに変換します。
   エディタ内でF9keyを押下してください。
   https://rawgit.com/nojaja/node-htmlparser/v2.1/lib/htmlparser.js
   https://rawgit.com/nojaja/node-htmlcompiler/v1.0.1/lib/htmlcompiler.js
  </pre>
  <select id='targeturl' name='targeturl'>
  <option value=''>-</option>
  <option value='https://codepen.io/nojaja/pen/mmYdwe.html'>test1</option>
  <option value='https://codepen.io/nojaja/pen/YVbzRw.html'>test2</option>
  <option value='https://codepen.io/nojaja/pen/ZKNJgG.html'>test3</option>
  <option value='https://codepen.io/nojaja/pen/GmaOqg.html'>uikit</option>
  <option value='https://codepen.io/nojaja/pen/dRPBpO.html'>test4</option>
  </select>

</div><br>

<div class="code-frame">
  <div class="code-lang"><span class="bold">source html (F9 key:execute)</span></div>
  <div id="container" class="editor"></div>
</div>
<div class="code-frame">
  <div class="code-lang"><span class="bold">dom tree</span></div>
  <div id="container2" class="editor"></div>
</div>

<div class="code-frame">
  <div class="code-lang"><span class="bold">html</span></div>
  <div id="container3" class="editor"></div>
</div>
  
<div class="code-frame">
  <div class="code-lang"><span class="bold">css</span></div>
  <div id="container4" class="editor"></div>
</div>
<div class="code-frame">
  <div class="code-lang"><span class="bold">javascript component.js</span></div>
  <div id="container5" class="editor"></div>
</div>
<div class="code-frame">
  <div class="code-lang"><span class="bold">javascript app.js</span></div>
  <div id="container6" class="editor"></div>
</div>
<div class="code-frame">
  <div class="code-lang"><span class="bold">Preview</span></div>
  <iframe id="child-frame" class="editor"></iframe>
</div>
	
<script id="input" language='text'>
&gl;html&gt;
&gl;body&gt;

		&gl;div className="uk-section uk-section-default uk-section-small uk-padding-remove-top"&gt;
      &gl;div id='target' className='uk-container'&gt;
 
    		&gl;div className="uk-child-width-1-4@m uk-grid-match" uk-grid=""&gt;
      
        &gl;Reactcard title='Test' &gt;
          &gl;Reactinput label='input' &gt;&gl;/Reactinput&gt;
          &gl;Reactlabel id='hoge' label='message' &gt;&gl;/Reactlabel&gt;
          &gl;p&gt;Lorem ipsum &gl;a href="#"&gt;dolor&gl;/a&gt; sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.&gl;/p&gt;
          &gl;Reactmargin&gt;
        		&gl;Reactbutton label='Action1' href='#' &gt;&gl;/Reactbutton&gt;
          &gl;/Reactmargin&gt;
  			&gl;/Reactcard&gt;
  
        &gl;/div&gt;
      &gl;/div&gt;
    &gl;/div&gt;
  
&gl;element name="Reactlabel"&gt;
  &gl;template&gt;
      &gl;div&gt;
  			&gl;span className="uk-label"&gt;{this.props.label}&gl;/span&gt;&gl;label id='caption'&gt;{store.getState().main.message}&gl;/label&gt;
      &gl;/div&gt;
  &gl;/template&gt;
&gl;/element&gt;
     
&gl;element name="Reactlabel"&gt;
  &gl;template&gt;
      &gl;div&gt;
  			&gl;span className="uk-label"&gt;{this.props.label}&gl;/span&gt;&gl;label id='caption'&gt;{store.getState().main.message}&gl;/label&gt;
      &gl;/div&gt;
  &gl;/template&gt;
&gl;/element&gt;
  
&gl;element name="Reactinput"&gt;
  &gl;script language='es6'&gt;
   handleChange:function(e) {
    TestAction.change(e.target.value);
  }
  &gl;/script&gt;
  &gl;template&gt;
    &gl;div&gt;
 			&gl;span className="uk-label"&gt;{this.props.label}&gl;/span&gt;
      &gl;input id='message' className='uk-input' value={store.getState().main.message} onChange={this.handleChange}  /&gt;
    &gl;/div&gt;
  &gl;/template&gt;
&gl;/element&gt;
  
&gl;element name="Reactbutton"&gt;
  &gl;template&gt;
        &gl;a className="uk-button uk-button-default" href="{this.props.href}"&gt;{this.props.label}&gl;/a&gt;
  &gl;/template&gt;
&gl;/element&gt;
  
&gl;element name="Reactmargin"&gt;
  &gl;template&gt;
        &gl;p uk-margin=""&gt;{this.props.children}&gl;/p&gt;
  &gl;/template&gt;
&gl;/element&gt;
  
&gl;element name="Reactcard"&gt;
  &gl;template&gt;
  		&gl;div&gt;
        &gl;div className="uk-card uk-card-primary uk-card-hover"&gt;
          &gl;div className="uk-card-body"&gt;
            &gl;h3 className="uk-card-title"&gt;{this.props.title}&gl;/h3&gt;
  					{this.props.children}
          &gl;/div&gt;
        &gl;/div&gt;
      &gl;/div&gt;
  &gl;/template&gt;
&gl;/element&gt;
  
&gl;/body&gt;
&gl;/html&gt;
</script>
<script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.5/js/uikit.min.js'></script>
<script src='https://fb.me/react-15.1.0.js'></script>
<script src='https://fb.me/react-dom-15.1.0.js'></script>
<script src='https://nojaja.github.io/node-htmlcompiler/CSSOM.js'></script>
<script src='https://rawgit.com/nojaja/node-htmlparser/v2.2.snapshot/lib/htmlparser.js'></script>
<script src='https://rawgit.com/nojaja/node-htmlcompiler/v1.0.2/lib/htmlcompiler.js'></script>
<script src='https://microsoft.github.io/monaco-editor/node_modules/monaco-editor/min/vs/loader.js'></script>
<script>'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var htmlparser = Tautologistics.NodeHtmlParser;

var parseHtml = function parseHtml(rawHtml) {
  return htmlparser.parseDOM(rawHtml, {
    enforceEmptyTags: true,
    ignoreWhitespace: true,
    caseSensitiveTags:true,
    caseSensitiveAttr:true,
    verbose: false
  });
};

var DebugBuilder = function (_Builder) {
  _inherits(DebugBuilder, _Builder);

  function DebugBuilder() {
    _classCallCheck(this, DebugBuilder);

    return _possibleConstructorReturn(this, _Builder.apply(this, arguments));
  }

  DebugBuilder.prototype.beforeCompile = function beforeCompile(src) {
    console.log('DebugBuilder', stringify(src));
  };

  DebugBuilder.prototype.beforeCreateNodes = function beforeCreateNodes(src) {
    console.log('DebugBuilder-createNodes', stringify(src));
  };

  DebugBuilder.prototype.beforeCreateTagElement = function beforeCreateTagElement(src) {
    console.log('DebugBuilder-beforeCreateTagElement', stringify(src));
  };

  return DebugBuilder;
}(Builder);

;

//View///////////////////////////////////////////////////
$(function () {
  require.config({
    paths: {
      vs: "https://microsoft.github.io/monaco-editor/node_modules/monaco-editor/min/vs"
    }
  });
  require(["vs/editor/editor.main"], function () {
    var editor = monaco.editor.create(document.getElementById("container"), {
      language: "html"
    });

    var input = document.getElementById("input").innerHTML.trim();
    input = input.replace(/&gl;/g, "<").replace(/&gt;/g, ">");
    editor.setValue(input);
    $("#targeturl").change( function(){
      $.ajax({
        url: $('#targeturl').val(),
        dataType: 'html'
      }).done(function(d) {
        editor.setValue(d);
      }) 
    });

    var editor2 = monaco.editor.create(document.getElementById("container2"), {
      language: "json"
    });
    var editor3 = monaco.editor.create(document.getElementById("container3"), {
      language: "html"
    });
    var editor4 = monaco.editor.create(document.getElementById("container4"), {
      language: "css"
    });
    var editor5 = monaco.editor.create(document.getElementById("container5"), {
      language: "javascript"
    });
    var editor6 = monaco.editor.create(document.getElementById("container6"), {
      language: "javascript"
    });
	var myBinding = editor.addCommand(monaco.KeyCode.F9, function () {
      var webComponentParser = new WebComponentParser({
		  builder: ReactComponentBuilder
      });

      var reactRootParser = new ReactRootComponentBuilder({
		  builder: ReactComponentBuilder
      });

      var builder = new HtmlBuilder({});
      var debugBuilder = new DebugBuilder({});
      var cssbuilder = new CSSBuilder({});
      var reactComponentBuilder = new ReactComponentBuilder({});
      var compiler1 = new Compiler([cssbuilder,webComponentParser,reactRootParser], {});
      var compiler2 = new Compiler([builder], {});

      //-ここからDemo用処理----------------------------------
      var parseData = parseHtml(editor.getValue().trim());
      compiler1.compile(parseData);//jsonオブジェクトを各種コードに変換します

      editor2.setValue(stringify(parseData));
      console.log(stringify(builder.getNodes()));
      editor4.setValue(cssbuilder.getNodes());

      webComponentParser.build(); //react化処理の実行
      //変換されたコードはwindowに読み込まれ実行可能になります。
      reactRootParser.build(); //react化処理の実行
      //変換されたコードはwindowに読み込まれ実行可能になります。
      editor5.setValue(webComponentParser.getResult());
      editor6.setValue(reactRootParser.getResult());

      var bodyElements = parseData.getElementsByTagName("body");
      if(parseData.getElementsByTagName('head').length==0){
        var $html = parseData.getElementsByTagName("html");
        var newElement = $html[0].createElement('head');
        $html[0].insertBefore(newElement,bodyElements[0]);
      };
      
      //parseData =(parseData.getElementsByTagName('body').length>0)?parseData.getElementsByTagName('body')[0].children:parseData;
      var headElements = parseData.getElementsByTagName("head");
      headElements.forEach(function(headElement){
        //head配下に追加
        var addpoint = headElement.getElementsByTagName("script")[0];
        
        {
        var newElement = headElement.createElement('script');
        var child = newElement.createTextNode(reactRootParser.getResult());
        newElement.appendChild(child);
        headElement.insertBefore(newElement,addpoint);
        addpoint=newElement;
        }
        {
        var newElement = headElement.createElement('script');
        var child = newElement.createTextNode(webComponentParser.getResult());
        newElement.appendChild(child);
        headElement.insertBefore(newElement,addpoint);
        addpoint=newElement;
        }
        {
        var newElement = headElement.createElement('script');
        newElement.attributes = {'src':[{
															"type": "text",
															"data": "https://fb.me/react-dom-15.1.0.js"
														}]};
        headElement.insertBefore(newElement,addpoint);
        addpoint=newElement;
        }
        {
        var newElement = headElement.createElement('script');
        newElement.attributes = {'src':[{
															"type": "text",
															"data": "https://fb.me/react-15.1.0.js"
														}]};
        headElement.insertBefore(newElement,addpoint);
        addpoint=newElement;
        }
        {
        var newElement = headElement.createElement('script');
        newElement.attributes = {'src':[{
															"type": "text",
															"data": "//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"
														}]};
        headElement.insertBefore(newElement,addpoint);
        addpoint=newElement;
        }
      },this);
      
      bodyElements.forEach(function(bodyElement){
        {
        var newElement = bodyElement.createElement('script');
        var child = newElement.createTextNode(`
 var render = function render() {
  ReactDOM.render(
    React.createElement(App, null),
    document.querySelector("#app")
  );
};

$(function() {
  /* render initial component */
  render();
});
`);
        newElement.appendChild(child);
        bodyElement.appendChild(newElement);
        }
      },this);
      
      //parseData =(parseData.getElementsByTagName('body').length>0)?parseData.getElementsByTagName('body')[0].children:parseData;
      compiler2.compile(parseData.children);//jsonオブジェクトを各種コードに変換します
      editor3.setValue(builder.getNodes());
      // iframe内のコンテンツのdocumentオブジェクト追加
      $('#child-frame').attr("srcdoc",builder.getNodes());
      
      
    });
  });
});

function stringify(str) {
  var cache = [];
  return JSON.stringify(str, function (key, value) {
    if ((typeof value === 'undefined' ? 'undefined' : _typeof(value)) === "object" && value !== null) {
      if (cache.indexOf(value) !== -1) {
        // Circular reference found, discard key
        return;
      }
      // Store value in our collection
      cache.push(value);
    }
    if (key == "parentNode") return;
    return value;
  }, "\t");
}
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-101081454-1', 'auto');
  ga('send', 'pageview');

</script>
</body></html>
